name: eBay UI CI

on:
    pull_request:
        types: [opened, synchronize]
    push:
        branches: ["master", "[1-9][0-9].*"]

concurrency:
    group: "${{ github.workflow }}-${{ github.event_name == 'pull_request_target' && github.head_ref || github.ref }}"
    cancel-in-progress: true

permissions:
    actions: write
    checks: write
    contents: write
    deployments: write
    discussions: write
    issues: write
    packages: write
    id-token: write
    pull-requests: write
    repository-projects: write
    security-events: write
    statuses: write

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@master
            - uses: actions/setup-node@master
              with:
                  node-version: "18"
            - uses: webfactory/ssh-agent@v0.5.4
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
            - run: npm i
            - run: npm run build:ci
              env:
                  BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
                  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
                  BROWSERSTACK_PROJECT_NAME: "CoreUI"
                  BUILD_NUMBER: CI
                  REPO_SLUG: ebay/ebayui-core
            - uses: coverallsapp/github-action@master
              if: ${{ success() }}
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  path-to-lcov: .coverage/lcov.info
    release:
        # Sets permissions of the GITHUB_TOKEN to allow opening release PR
        permissions:
            id-token: write
            contents: write
            packages: write
            pull-requests: write
            issues: read
        runs-on: ubuntu-latest
        needs: [build]
        if: "${{ github.repository_owner == 'ebay' && github.event_name == 'push' }}"
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: "18"
                  cache: npm
            - name: Install dependencies
              run: npm i
            - name: Enter prerelease mode
              if: ${{ github.ref != 'refs/heads/master' }}
              run: npm run prerelease:start
            - name: Exit prerelease mode
              if: ${{ github.ref == 'refs/heads/master' }}
              run: npm run prerelease:end
            - name: Release
              id: changesets
              uses: changesets/action@v1
              with:
                  version: npm run version
                  publish: npm run release
                  commit: "ci: release"
                  title: "ci: release"
              env:
                  # Disable husky
                  HUSKY: 0
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
